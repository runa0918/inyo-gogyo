// ========= æ—©è¦‹è¡¨ï¼ˆ1940ã€œ2010ï¼‰ =========
const HAYAMIHYO = {
  1940:[39,10,39,10,40,11,41,12,43,13,44,14],
  1941:[45,16,44,15,45,16,46,17,48,18,49,19],
  1942:[50,21,49,20,50,21,51,22,53,23,54,24],
  1943:[55,26,54,25,55,26,56,27,58,28,59,29],
  1944:[0,31,0,31,1,32,2,33,4,34,5,35],
  1945:[6,37,5,36,6,37,7,38,9,39,10,40],
  1946:[11,42,10,41,11,42,12,43,14,44,15,45],
  1947:[16,47,15,46,16,47,17,48,19,49,20,50],
  1948:[21,52,21,52,22,53,23,54,25,55,26,56],
  1949:[27,58,26,57,27,58,28,59,30,0,31,1],

  1950:[32,3,31,2,32,3,33,4,35,5,36,6],
  1951:[37,8,36,7,37,8,38,9,40,10,41,11],
  1952:[42,13,42,13,43,14,44,15,46,16,47,17],
  1953:[48,19,47,18,48,19,49,20,51,21,52,22],
  1954:[53,24,52,23,53,24,54,25,56,26,57,27],
  1955:[58,29,57,28,58,29,59,30,1,31,2,32],
  1956:[3,34,3,34,4,35,5,36,7,37,8,38],
  1957:[9,40,8,39,9,40,10,41,12,42,13,43],
  1958:[14,45,13,44,14,45,15,46,17,47,18,48],
  1959:[19,50,18,49,19,50,20,51,22,52,23,53],

  1960:[24,55,24,55,25,56,26,57,28,58,29,59],
  1961:[30,1,29,60,30,1,31,2,33,3,34,4],
  1962:[35,6,34,5,35,6,36,7,38,8,39,9],
  1963:[40,11,39,10,40,11,41,12,43,13,44,14],
  1964:[45,16,45,16,46,17,47,18,49,19,50,20],
  1965:[51,22,50,21,51,22,52,23,54,24,55,25],
  1966:[56,27,55,26,56,27,57,28,59,29,60,30],
  1967:[1,32,0,31,1,32,2,33,4,34,5,35],
  1968:[6,37,6,37,7,38,8,39,10,40,11,41],
  1969:[12,43,11,42,12,43,13,44,15,45,16,46],

  1970:[17,48,16,47,17,48,18,49,20,50,21,51],
  1971:[22,53,21,52,22,53,23,54,25,55,26,56],
  1972:[27,58,27,58,28,59,29,0,31,1,32,2],
  1973:[33,4,32,3,33,4,34,5,36,6,37,7],
  1974:[38,9,37,8,38,9,39,10,41,11,42,12],
  1975:[43,14,42,13,43,14,44,15,46,16,47,17],
  1976:[48,19,48,19,49,20,50,21,52,22,53,23],
  1977:[54,25,53,24,54,25,55,26,57,27,58,28],
  1978:[59,30,58,29,59,30,0,31,2,32,3,33],
  1979:[4,35,3,34,4,35,5,36,7,37,8,38],

  1980:[9,40,9,40,10,41,11,42,13,43,14,44],
  1981:[15,46,14,45,15,46,16,47,18,48,19,49],
  1982:[20,51,19,50,20,51,21,52,23,53,24,54],
  1983:[25,56,24,55,25,56,26,57,28,58,29,59],
  1984:[30,1,30,1,31,2,32,3,34,4,35,5],
  1985:[36,7,35,6,36,7,37,8,39,9,40,10],
  1986:[41,12,40,11,41,12,42,13,44,14,45,15],
  1987:[46,17,45,16,46,17,47,18,49,19,50,20],
  1988:[51,22,51,22,52,23,53,24,55,25,56,26],
  1989:[57,28,56,27,57,28,58,29,0,30,1,31],

  1990:[2,33,1,32,2,33,3,34,5,35,6,36],
  1991:[7,38,6,37,7,38,8,39,10,40,11,41],
  1992:[12,43,12,43,13,44,14,45,16,46,17,47],
  1993:[18,49,17,48,18,49,19,50,21,51,22,52],
  1994:[23,54,22,53,23,54,24,55,26,56,27,57],
  1995:[28,59,27,58,28,59,29,60,31,1,32,2],
  1996:[33,4,33,4,34,5,35,6,37,7,38,8],
  1997:[39,10,38,9,39,10,40,11,42,12,43,13],
  1998:[44,15,43,14,44,15,45,16,47,17,48,18],
  1999:[49,20,48,19,49,20,50,21,52,22,53,23],

  2000:[54,25,24,25,55,26,56,27,58,28,59,29],
  2001:[0,31,59,30,60,31,1,32,3,33,4,34],
  2002:[5,36,4,35,5,36,6,37,8,38,9,39],
  2003:[10,41,9,40,10,41,11,42,13,43,14,44],
  2004:[15,46,15,46,16,47,17,48,19,49,20,50],
  2005:[21,52,20,51,21,52,22,53,24,54,25,55],
  2006:[26,57,25,56,26,57,27,58,29,59,30,60],
  2007:[31,2,30,1,31,2,32,3,34,4,35,5],
  2008:[36,7,36,7,37,8,38,9,40,10,41,11],
  2009:[42,13,41,12,42,13,43,14,45,15,46,16],
  2010:[47,18,46,17,47,18,48,19,50,20,51,21],
};

// ========= é‹å‘½æ•°â†’åå¹²/å±žæ€§ =========
const UNMEI_MAP = {
  1: { jikkan: "ç”²ï¼ˆãã®ãˆï¼‰", attr: "æœ¨ã®é™½" },
  2: { jikkan: "ä¹™ï¼ˆãã®ã¨ï¼‰", attr: "æœ¨ã®é™°" },
  3: { jikkan: "ä¸™ï¼ˆã²ã®ãˆï¼‰", attr: "ç«ã®é™½" },
  4: { jikkan: "ä¸ï¼ˆã²ã®ã¨ï¼‰", attr: "ç«ã®é™°" },
  5: { jikkan: "æˆŠï¼ˆã¤ã¡ã®ãˆï¼‰", attr: "åœŸã®é™½" },
  6: { jikkan: "å·±ï¼ˆã¤ã¡ã®ã¨ï¼‰", attr: "åœŸã®é™°" },
  7: { jikkan: "åºšï¼ˆã‹ã®ãˆï¼‰", attr: "é‡‘ã®é™½" },
  8: { jikkan: "è¾›ï¼ˆã‹ã®ã¨ï¼‰", attr: "é‡‘ã®é™°" },
  9: { jikkan: "å£¬ï¼ˆã¿ãšã®ãˆï¼‰", attr: "æ°´ã®é™½" },
  0: { jikkan: "ç™¸ï¼ˆã¿ãšã®ã¨ï¼‰", attr: "æ°´ã®é™°" },
};

// ========= æ€§è³ªï¼ˆä»®ï¼‰ =========
const NATURE = {
  "æœ¨ã®é™½": "ã®ã³ã®ã³é–‹æ‹“åž‹ã€‚æ–°ã—ã„æµã‚Œã‚’ä½œã‚‹ã®ãŒå¾—æ„ã€‚èŠ¯ãŒå¼·ãã€æ±ºã‚ãŸã‚‰é€Ÿã„ã€‚",
  "æœ¨ã®é™°": "èª¿æ•´ã¨è‚²æˆãŒå¾—æ„ã€‚ç›¸æ‰‹ã«åˆã‚ã›ã¦æˆé•·ã‚’æ”¯ãˆã‚‹ã€‚é™ã‹ãªç²˜ã‚Šå¼·ã•ã€‚",
  "ç«ã®é™½": "æƒ…ç†±ã¨çªç ´åŠ›ã€‚å‰ã«å‡ºã¦å ´ã‚’æ˜Žã‚‹ãã§ãã‚‹ã€‚å‹¢ã„ã‚’æ´»ã‹ã™ã¨å¼·ã„ã€‚",
  "ç«ã®é™°": "æ„Ÿæ€§ã¨è¡¨ç¾åŠ›ã€‚ç©ºæ°—ã‚’èª­ã‚“ã§é­…ã›ã‚‹ã®ãŒä¸Šæ‰‹ã€‚ç¹Šç´°ã•ãŒæ­¦å™¨ã€‚",
  "åœŸã®é™½": "å®‰å®šã¨çµ±çŽ‡ã€‚ä»»ã•ã‚Œã‚‹ã»ã©åŠ›ãŒå‡ºã‚‹ã€‚ç¾å®Ÿçš„ã«ç‰©äº‹ã‚’å›žã›ã‚‹ã€‚",
  "åœŸã®é™°": "å—å®¹ã¨é¢å€’è¦‹ã€‚äººã®é–“ã‚’ã¤ãªãèª¿æ•´å½¹ã€‚å …å®Ÿã§ä¿¡é ¼ã•ã‚Œã‚„ã™ã„ã€‚",
  "é‡‘ã®é™½": "æ±ºæ–­ã¨å®Ÿè¡Œã€‚ç™½é»’ã¯ã£ãã‚Šã€å“è³ªé‡è¦–ã€‚ãƒ«ãƒ¼ãƒ«ä½œã‚Šã‚„æ”¹å–„ãŒå¾—æ„ã€‚",
  "é‡‘ã®é™°": "æ´—ç·´ã¨ç¾Žæ„è­˜ã€‚ç´°éƒ¨ã¾ã§æ•´ãˆã‚‹åŠ›ã€‚å¯©ç¾Žçœ¼ã¨åˆ†æžåŠ›ã§ç²¾åº¦ã‚’ä¸Šã’ã‚‹ã€‚",
  "æ°´ã®é™½": "çŸ¥æ€§ã¨è¡Œå‹•ã€‚æƒ…å ±ã‚’æŽ´ã‚€ã®ãŒé€Ÿãã€å‹•ããªãŒã‚‰æœ€é©åŒ–ã§ãã‚‹ã€‚",
  "æ°´ã®é™°": "æ´žå¯Ÿã¨æŸ”è»Ÿæ€§ã€‚è¦³å¯Ÿã—ã¦æ·±ãèª­ã‚€ã‚¿ã‚¤ãƒ—ã€‚é™ã‹ã«å¼·ã„å¼•åŠ›ã‚’æŒã¤ã€‚",
};

function fmtJP(y,m,d){ return `${y}å¹´${m}æœˆ${d}æ—¥`; }

function calcInyoGogyo(date) {
  const y = date.getFullYear();
  const m = date.getMonth() + 1; // 1..12
  const d = date.getDate();

  const row = HAYAMIHYO[y];
  if (!row) throw new Error(`æ—©è¦‹è¡¨ã®å¯¾å¿œå¹´ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ1940ã€œ2010ï¼‰: ${y}å¹´`);

  const base = row[m - 1];
  const sum = base + d;
  const unmei = sum % 10;
  const info = UNMEI_MAP[unmei];

  return {
    y, m, d,
    base, sum, unmei,
    jikkan: info.jikkan,
    attr: info.attr,
    nature: NATURE[info.attr] || "ï¼ˆæ€§è³ªæ–‡ æœªè¨­å®šï¼‰",
  };
}

// ========= UI =========
const birth = document.getElementById("birth");
const btnRun = document.getElementById("btnRun");
const btnReset = document.getElementById("btnReset");
const btnShare = document.getElementById("btnShare");
const btnCopy = document.getElementById("btnCopy");
const result = document.getElementById("result");
const note = document.getElementById("note");

function setNote(msg, isError=false){
  note.textContent = msg;
  note.classList.toggle("error", isError);
}

function buildShareText(r){
  return `é™°é™½äº”è¡Œå ã„\n${fmtJP(r.y,r.m,r.d)}\nå±žæ€§ï¼š${r.attr}\nåå¹²ï¼š${r.jikkan}\né‹å‘½æ•°ï¼š${r.unmei}\n\n${location.href}`;
}

function render(r){
  document.getElementById("birthText").textContent = `ðŸ“… ${fmtJP(r.y,r.m,r.d)}`;
  document.getElementById("attrText").textContent = `${r.attr}`;
  document.getElementById("heroSub").textContent = `${r.jikkan} / é‹å‘½æ•° ${r.unmei}`;
  document.getElementById("unmeiText").textContent = `${r.unmei}`;
  document.getElementById("jikkanText").textContent = `${r.jikkan}`;
  document.getElementById("natureText").textContent = r.nature;
  document.getElementById("detailText").textContent =
    `æ—©è¦‹è¡¨ï¼ˆå¹´Ã—æœˆï¼‰: ${r.base}\n` +
    `åˆè¨ˆï¼ˆæ—©è¦‹è¡¨ + æ—¥ï¼‰: ${r.base} + ${r.d} = ${r.sum}\n` +
    `é‹å‘½æ•°ï¼ˆ1ã®ä½ï¼‰: ${r.unmei}`;

  result.classList.add("show");
  result.scrollIntoView({ behavior:"smooth", block:"start" });
}

function run(){
  if (!birth.value) {
    setNote("ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ã­ï¼", true);
    alert("ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
    return;
  }

  const d = new Date(birth.value + "T00:00:00");
  try {
    setNote("â€»æ—©è¦‹è¡¨ï¼ˆ1940ã€œ2010ï¼‰ã«å¯¾å¿œã€‚ç¯„å›²å¤–ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚", false);
    const r = calcInyoGogyo(d);
    render(r);
  } catch (e) {
    setNote(e.message, true);
    alert(e.message);
  }
}

function reset(){
  result.classList.remove("show");
  setNote("â€»æ—©è¦‹è¡¨ï¼ˆ1940ã€œ2010ï¼‰ã«å¯¾å¿œã€‚ç¯„å›²å¤–ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚", false);
}

btnRun.addEventListener("click", run);
btnReset.addEventListener("click", () => { reset(); });

birth.addEventListener("keydown", (e) => {
  if (e.key === "Enter") run();
});

// åˆæœŸå€¤ï¼šä»Šæ—¥ï¼ˆå¥½ã¿ã§æ¶ˆã—ã¦OKï¼‰
(() => {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  if (!birth.value) birth.value = `${yyyy}-${mm}-${dd}`;
})();

btnCopy?.addEventListener("click", async () => {
  if (!result.classList.contains("show")) return alert("å…ˆã«å ã£ã¦ã­ï¼");
  const d = new Date(birth.value + "T00:00:00");
  const r = calcInyoGogyo(d);
  const text = buildShareText(r);

  try{
    await navigator.clipboard.writeText(text);
    alert("çµæžœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
  }catch{
    // clipboardä¸å¯ç’°å¢ƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    prompt("ã‚³ãƒ”ãƒ¼ã—ã¦ã­", text);
  }
});

btnShare?.addEventListener("click", async () => {
  if (!result.classList.contains("show")) return alert("å…ˆã«å ã£ã¦ã­ï¼");
  const d = new Date(birth.value + "T00:00:00");
  const r = calcInyoGogyo(d);
  const text = buildShareText(r);

  if (navigator.share){
    try{
      await navigator.share({ title: "é™°é™½äº”è¡Œå ã„", text });
    }catch{
      // shareã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ç„¡è¦–
    }
  }else{
    // shareéžå¯¾å¿œã¯ã‚³ãƒ”ãƒ¼ã¸
    try{
      await navigator.clipboard.writeText(text);
      alert("å…±æœ‰æ©Ÿèƒ½ãŒç„¡ã„ã®ã§ã€çµæžœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    }catch{
      prompt("å…±æœ‰ç”¨ãƒ†ã‚­ã‚¹ãƒˆ", text);
    }
  }
});

// ========= PWA (Service Worker) =========
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  });
}
